<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Fotovoltaico - Kiosk</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Base styles */
      body {
        font-family: "Inter", sans-serif;
        transition: background-color 0.3s, color 0.3s;
      }
      .card {
        transition: background-color 0.3s, border-color 0.3s;
        border: 1px solid transparent;
      }

      /* Dark theme (default) */
      body.dark {
        background-color: #111827; /* gray-900 */
        color: #d1d5db; /* gray-300 */
      }
      .dark .card {
        background-color: #1f2937; /* gray-800 */
        border-color: #374151; /* gray-700 */
      }
      .dark .main-title {
        color: #ffffff;
      }
      .dark .sub-title {
        color: #9ca3af;
      } /* gray-400 */
      .dark #status-overlay .bg-overlay {
        background-color: #111827;
      }

      /* Light theme */
      body.light {
        background-color: #f3f4f6; /* gray-100 */
        color: #374151; /* gray-700 */
      }
      .light .card {
        background-color: #ffffff;
        border-color: #e5e7eb; /* gray-200 */
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1),
          0 1px 2px -1px rgba(0, 0, 0, 0.1);
      }
      .light .main-title {
        color: #111827;
      } /* gray-900 */
      .light .sub-title {
        color: #6b7280;
      } /* gray-500 */
      .light #status-overlay .bg-overlay {
        background-color: #f3f4f6;
      }
      .light #status-overlay .text-overlay {
        color: #111827;
      }

      /* Status overlay styles */
      #status-overlay {
        transition: opacity 0.5s;
      }

      /* New classes for text scaling */
      /* Sets the base font size for the entire page */
      body.text-size-normal {
        font-size: 16px;
      } /* Standard size */
      body.text-size-large {
        font-size: 18px;
      } /* 12.5% larger text */
      body.text-size-xlarge {
        font-size: 22px;
      } /* 37.5% larger text */
    </style>
  </head>
  <body>
    <!-- Overlay for Loading and Error states -->
    <div
      id="status-overlay"
      class="fixed inset-0 z-50 flex items-center justify-center"
    >
      <div class="bg-overlay absolute inset-0 opacity-95"></div>
      <div class="relative text-center text-overlay p-8">
        <!-- Loading Indicator -->
        <div id="loading-indicator">
          <svg
            class="animate-spin h-10 w-10 text-green-500 mx-auto"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            ></path>
          </svg>
          <p id="label-loading" class="mt-4 text-lg font-medium"></p>
        </div>
        <!-- Error Message (hidden by default) -->
        <div id="error-message" class="hidden">
          <svg
            class="h-12 w-12 text-red-500 mx-auto"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"
            />
          </svg>
          <h2
            id="label-error-title"
            class="mt-4 text-2xl font-bold text-red-500"
          ></h2>
          <p id="label-error-message" class="mt-2"></p>
          <p id="label-error-retry" class="mt-1 text-sm sub-title"></p>
        </div>
      </div>
    </div>

    <div
      id="dashboard-content"
      class="container mx-auto p-4 sm:p-6 lg:p-8 opacity-0"
      style="transition: opacity 0.5s"
    >
      <!-- Header -->
      <header
        class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6"
      >
        <div>
          <h1
            id="stationName"
            class="text-2xl lg:text-3xl font-bold main-title"
          ></h1>
          <p id="stationAddress" class="text-sm sub-title mt-1"></p>
        </div>
        <div class="text-right mt-4 sm:mt-0">
          <p id="label-last-update" class="text-sm sub-title"></p>
          <p id="lastUpdated" class="text-lg font-semibold main-title"></p>
          <!-- Subtle error message container -->
          <p
            id="subtle-error-message"
            class="text-xs text-red-500 font-semibold mt-1 hidden"
          ></p>
        </div>
      </header>

      <!-- KPI Grid -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="card rounded-xl p-6 flex items-center space-x-4">
          <div class="bg-green-500/20 p-3 rounded-full">
            <svg
              class="h-8 w-8 text-green-500"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
          </div>
          <div>
            <p id="label-realtime-power" class="text-sm sub-title"></p>
            <p id="realTimePower" class="text-2xl font-bold main-title"></p>
          </div>
        </div>
        <div class="card rounded-xl p-6 flex items-center space-x-4">
          <div class="bg-yellow-500/20 p-3 rounded-full">
            <svg
              class="h-8 w-8 text-yellow-500"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
              />
            </svg>
          </div>
          <div>
            <p id="label-daily-energy" class="text-sm sub-title"></p>
            <p id="dailyEnergy" class="text-2xl font-bold main-title"></p>
          </div>
        </div>
        <div class="card rounded-xl p-6 flex items-center space-x-4">
          <div class="bg-blue-500/20 p-3 rounded-full">
            <svg
              class="h-8 w-8 text-blue-500"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
          </div>
          <div>
            <p id="label-monthly-energy" class="text-sm sub-title"></p>
            <p id="monthEnergy" class="text-2xl font-bold main-title"></p>
          </div>
        </div>
        <div class="card rounded-xl p-6 flex items-center space-x-4">
          <div class="bg-purple-500/20 p-3 rounded-full">
            <svg
              class="h-8 w-8 text-purple-500"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2h10a2 2 0 002-2v-1a2 2 0 012-2h1.945M7.737 16.525l-.425.85A2 2 0 015.012 18H5a2 2 0 01-2-2V8a2 2 0 012-2h.012a2 2 0 011.723 1.375l.425.85m10.84 6.3a2 2 0 00-1.723-1.375h-.012a2 2 0 00-2 2v8a2 2 0 002 2h.012a2 2 0 001.723-1.375l.425-.85M12 12h.01"
              />
            </svg>
          </div>
          <div>
            <p id="label-yearly-energy" class="text-sm sub-title"></p>
            <p id="yearEnergy" class="text-2xl font-bold main-title"></p>
          </div>
        </div>
      </div>

      <!-- Chart and Environmental Contribution Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="card lg:col-span-2 rounded-xl p-6">
          <h2
            id="label-power-curve"
            class="text-lg font-semibold main-title mb-4"
          ></h2>
          <div class="h-80"><canvas id="powerCurveChart"></canvas></div>
        </div>
        <div class="card rounded-xl p-6 flex flex-col">
          <h2
            id="label-env-contribution"
            class="text-lg font-semibold main-title mb-4"
          ></h2>
          <div class="space-y-5 flex-grow flex flex-col justify-around">
            <div class="flex items-center">
              <div class="bg-teal-500/20 p-3 rounded-full mr-4">
                <svg
                  class="h-7 w-7 text-teal-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    fill-rule="evenodd"
                    d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
              </div>
              <div>
                <p id="co2Reduction" class="text-xl font-bold main-title"></p>
                <p id="label-co2-reduction" class="text-sm sub-title"></p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="bg-emerald-500/20 p-3 rounded-full mr-4">
                <svg
                  class="h-7 w-7 text-emerald-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    d="M17.388 1.252A1 1 0 0016.22.81l-6.53 3.003-2.894-1.89a1 1 0 00-1.174.092l-4 3.5a1 1 0 00.01 1.68l4 2.5a1 1 0 001.175-.092l2.893-1.89L16.22 11.19a1 1 0 001.168-.44l2-4a1 1 0 00-.52-1.332l-5-2.5a1 1 0 00-.48-.066z"
                  ></path>
                  <path
                    fill-rule="evenodd"
                    d="M1.5 12.5A1.5 1.5 0 003 14h14a1.5 1.5 0 001.5-1.5v-2A1.5 1.5 0 0017 9H3a1.5 1.5 0 00-1.5 1.5v2z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
              </div>
              <div>
                <p id="treePlanting" class="text-xl font-bold main-title"></p>
                <p id="label-equivalent-trees" class="text-sm sub-title"></p>
              </div>
            </div>
            <div class="flex items-center">
              <div class="bg-gray-500/20 p-3 rounded-full mr-4">
                <svg
                  class="h-7 w-7 text-gray-400"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path
                    d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zm0 2h10v10H5V5z"
                  ></path>
                  <path
                    d="M6 7a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm0 4a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1z"
                  ></path>
                </svg>
              </div>
              <div>
                <p id="coalSavings" class="text-xl font-bold main-title"></p>
                <p id="label-coal-savings" class="text-sm sub-title"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- DASHBOARD CONFIGURATION ---
      const config = {
        apiUrl:
          "https://corsproxy.io/?url=https://uni003eu5.fusionsolar.huawei.com/rest/pvms/web/kiosk/v1/station-kiosk-file?kk=xxxxxxx",
        refreshIntervalMinutes: 5,
        theme: "dark",
        // Text size option: 'normal', 'large', 'xlarge'
        textSize: "normal",
        // Language option: 'en' (English) or 'it' (Italian)
        language: "en",
      };
      // --- END OF CONFIGURATION ---

      // --- TRANSLATIONS ---
      const translations = {
        loading: { en: "Loading data...", it: "Caricamento dati in corso..." },
        errorTitle: { en: "Connection Error", it: "Errore di Connessione" },
        errorMessage: {
          en: "Could not retrieve data from the plant.",
          it: "Impossibile recuperare i dati dall'impianto.",
        },
        errorRetry: {
          en: "A new attempt will be made shortly.",
          it: "Verrà eseguito un nuovo tentativo a breve.",
        },
        connectionLost: {
          en: "Connection lost. Retrying...",
          it: "Connessione persa. Riprovo...",
        },
        lastUpdate: { en: "Last Update", it: "Ultimo Aggiornamento" },
        realTimePower: { en: "Real-time Power", it: "Potenza Istantanea" },
        dailyEnergy: { en: "Daily Production", it: "Produzione Giornaliera" },
        monthlyEnergy: { en: "Monthly Production", it: "Produzione Mensile" },
        yearlyEnergy: { en: "Yearly Production", it: "Produzione Annuale" },
        powerCurve: {
          en: "Daily Power Curve",
          it: "Curva di Potenza Giornaliera",
        },
        envContribution: {
          en: "Environmental Contribution",
          it: "Contributo Ambientale",
        },
        co2Reduction: { en: "CO₂ Reduction", it: "Riduzione CO₂" },
        equivalentTrees: { en: "Equivalent Trees", it: "Alberi Equivalenti" },
        coalSavings: { en: "Coal Savings", it: "Risparmio Carbone" },
        activePower: { en: "Active Power (kW)", it: "Potenza Attiva (kW)" },
      };
      // --- END OF TRANSLATIONS ---

      const statusOverlay = document.getElementById("status-overlay");
      const loadingIndicator = document.getElementById("loading-indicator");
      const errorMessage = document.getElementById("error-message");
      const dashboardContent = document.getElementById("dashboard-content");
      const subtleErrorEl = document.getElementById("subtle-error-message");
      let powerCurveChart = null;
      let hasLoadedOnce = false;

      // Function to get the translated string
      const t = (key) =>
        translations[key]?.[config.language] ||
        translations[key]?.["en"] ||
        key;

      // Function to set all static text elements on the page
      const applyStaticTranslations = () => {
        document.getElementById("label-loading").textContent = t("loading");
        document.getElementById("label-error-title").textContent =
          t("errorTitle");
        document.getElementById("label-error-message").textContent =
          t("errorMessage");
        document.getElementById("label-error-retry").textContent =
          t("errorRetry");
        document.getElementById("label-last-update").textContent =
          t("lastUpdate");
        document.getElementById("label-realtime-power").textContent =
          t("realTimePower");
        document.getElementById("label-daily-energy").textContent =
          t("dailyEnergy");
        document.getElementById("label-monthly-energy").textContent =
          t("monthlyEnergy");
        document.getElementById("label-yearly-energy").textContent =
          t("yearlyEnergy");
        document.getElementById("label-power-curve").textContent =
          t("powerCurve");
        document.getElementById("label-env-contribution").textContent =
          t("envContribution");
        document.getElementById("label-co2-reduction").textContent =
          t("co2Reduction");
        document.getElementById("label-equivalent-trees").textContent =
          t("equivalentTrees");
        document.getElementById("label-coal-savings").textContent =
          t("coalSavings");
      };

      // Apply theme and text size on startup
      document.body.classList.add(config.theme);
      document.body.classList.add(`text-size-${config.textSize}`);

      // Helper function to update a DOM element's text content
      const updateElement = (id, value, unit = "") => {
        const element = document.getElementById(id);
        if (element) element.textContent = `${value}${unit}`;
      };

      // Helper function to decode HTML entities from a string
      const decodeHtmlEntities = (text) => {
        // A temporary element is used to let the browser do the decoding
        const textarea = document.createElement("textarea");
        textarea.innerHTML = text;
        return textarea.value;
      };

      // Main function to update the dashboard UI with data
      const updateDashboardUI = (apiResponse) => {
        const decodedDataString = decodeHtmlEntities(apiResponse.data);
        const parsedData = JSON.parse(decodedDataString);
        const { realKpi, stationOverview, socialContribution, powerCurve } =
          parsedData;

        updateElement("stationName", stationOverview.stationName);
        updateElement(
          "stationAddress",
          stationOverview.plantAddress.replace(/([A-Z][a-z])/g, " $1").trim()
        );
        updateElement(
          "lastUpdated",
          new Date().toLocaleTimeString(
            config.language === "it" ? "it-IT" : "en-GB",
            { hour: "2-digit", minute: "2-digit" }
          )
        );
        updateElement("realTimePower", realKpi.realTimePower, " kW");
        updateElement("dailyEnergy", realKpi.dailyEnergy, " kWh");
        updateElement("monthEnergy", realKpi.monthEnergy, " kWh");
        updateElement("yearEnergy", realKpi.yearEnergy, " kWh");
        updateElement("co2Reduction", socialContribution.co2Reduction, " kg");
        updateElement(
          "treePlanting",
          socialContribution.equivalentTreePlanting
        );
        updateElement(
          "coalSavings",
          socialContribution.standardCoalSavings,
          " kg"
        );

        renderChart(powerCurve);
      };

      // Function to render the chart
      const renderChart = (powerCurve) => {
        if (powerCurveChart) powerCurveChart.destroy();
        const ctx = document.getElementById("powerCurveChart").getContext("2d");
        const chartData = powerCurve.activePower.map((v) =>
          v === "-" || v === null ? null : parseFloat(v)
        );
        const isLightTheme = config.theme === "light";
        const gridColor = isLightTheme
          ? "rgba(0, 0, 0, 0.1)"
          : "rgba(255, 255, 255, 0.1)";
        const tickColor = isLightTheme ? "#6b7280" : "#9ca3af";

        powerCurveChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: powerCurve.xAxis,
            datasets: [
              {
                label: t("activePower"),
                data: chartData,
                borderColor: "#22c55e",
                backgroundColor: "rgba(34, 197, 94, 0.2)",
                borderWidth: 2,
                pointRadius: 0,
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  color: tickColor,
                  maxRotation: 0,
                  autoSkip: true,
                  maxTicksLimit: 12,
                },
                grid: { color: gridColor },
              },
              y: {
                beginAtZero: true,
                ticks: { color: tickColor },
                grid: { color: gridColor },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: isLightTheme ? "#ffffff" : "#111827",
                titleColor: isLightTheme ? "#111827" : "#ffffff",
                bodyColor: isLightTheme ? "#374151" : "#d1d5db",
                borderColor: isLightTheme ? "#e5e7eb" : "#374151",
                borderWidth: 1,
                padding: 10,
                cornerRadius: 4,
                displayColors: false,
              },
            },
          },
        });
      };

      // Function to fetch data from the API
      const fetchData = async () => {
        // Show full-screen loader only on the first attempt
        if (!hasLoadedOnce) {
          statusOverlay.classList.remove("opacity-0", "pointer-events-none");
          loadingIndicator.classList.remove("hidden");
          errorMessage.classList.add("hidden");
        }

        try {
          const response = await fetch(config.apiUrl);
          if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
          const data = await response.json();

          // On success, update the UI
          updateDashboardUI(data);

          // Hide subtle error message if it was visible
          subtleErrorEl.classList.add("hidden");

          // If this was the first successful load, hide the overlay and show the content
          if (!hasLoadedOnce) {
            statusOverlay.classList.add("opacity-0", "pointer-events-none");
            dashboardContent.classList.remove("opacity-0");
            hasLoadedOnce = true;
          }
        } catch (error) {
          console.error("ERROR: Could not fetch data from the API.", error);
          if (hasLoadedOnce) {
            // If data was already loaded, show a subtle error
            subtleErrorEl.textContent = t("connectionLost");
            subtleErrorEl.classList.remove("hidden");
          } else {
            // If it's the first load and it fails, show the full-screen error
            loadingIndicator.classList.add("hidden");
            errorMessage.classList.remove("hidden");
          }
        }
      };

      // Run on startup
      document.addEventListener("DOMContentLoaded", () => {
        applyStaticTranslations();
        fetchData();
        setInterval(fetchData, config.refreshIntervalMinutes * 60 * 1000);
      });
    </script>
  </body>
</html>
